<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ page import="java.sql.*"%>       
<%@ page import="java.util.Date" %>
<%@ page import="java.text.SimpleDateFormat" %>
<%@ page import="java.util.Arrays" %>
<%@ page import="lib.DB" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Modify</title>
<style>
*{
	margin: 0 auto;
	padding: 0;
	text-align: center;
	box-sizing: border-box;
}
.write-form table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin: 20px auto;
    max-width: 600px;
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.write-form td {
    padding: 15px;
    border: 1px solid #e9ecef;
}

.write-form td:first-child {
    background-color: #f8f9fa;
    font-weight: bold;
    color: #495057;
    text-align: center;
    width: 120px;
}

.write-form input[type="text"],
.write-form textarea {
    width: calc(100% - 24px);
    padding: 10px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
    text-align: left;
}

.write-form textarea {
    height: 200px;
    resize: vertical;
}

.write-form .button-container {
    text-align: right;
}

.write-form .modify_sub,
.write-form .btn-cancel {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin-left: 8px;
}

.write-form .modify_sub {
    background-color: #007bff;
    color: white;
}

.write-form .modify_sub:hover {
    background-color: #0056b3;
}

.write-form .btn-cancel {
    background-color: #6c757d;
    color: white;
}

.write-form .btn-cancel:hover {
    background-color: #5a6268;
}

/* a íƒœê·¸ ì•ˆì— buttonì„ ë„£ì—ˆì„ ë•Œ ìŠ¤íƒ€ì¼ */
.write-form a {
    text-decoration: none;
}

.file-container {
  /* ì„¸ë¡œ ì •ë ¬(column) ëŒ€ì‹  ê°€ë¡œ ì •ë ¬(row)ë¡œ ë³€ê²½ */
  display: flex;
  flex-direction: row; 
  align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
  gap: 5px; /* ìš”ì†Œë“¤ ì‚¬ì´ì˜ ê°„ê²© */

  /* ë‚˜ë¨¸ì§€ ë””ìì¸ ìŠ¤íƒ€ì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ */
  padding: 3px;
  border-radius: 12px;
  background-color: white;
}

/* íŒŒì¼ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
.file-container input[type="file"] {
  /* ë„ˆë¹„ê°€ ë„ˆë¬´ ë„“ì–´ì§€ì§€ ì•Šë„ë¡ ì¡°ì • */
  width: 100%;
  max-width: 350px; /* ì ì ˆí•œ ë„ˆë¹„ë¡œ ì¡°ì •í•˜ì„¸ìš” */
  font-family: Arial, sans-serif;
  color: #555;
  border: 1px solid #BDBDBD;
  border-radius: 8px;
  padding: 10px 15px;
}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.file-container button {
  padding: 10px 18px;
  font-family: Arial, sans-serif;
  font-size: 14px;
  color: #555;
  background-color: #E0E0E0;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  width: fit-content;
}

/* í˜¸ë²„ íš¨ê³¼ */
.file-container button:hover {
  background-color: #BDBDBD;
}

/* ê¸°ì¡´íŒŒì¼ ë³´ì—¬ì£¼ëŠ” ë°•ìŠ¤ */
.file-item {
    display: flex; 
    align-items: center; 
    gap: 10px; 
    padding: 5px 0;
}

/* ê¸°ì¡´íŒŒì¼ ì´ë¦„ */
.file-name-display {
    flex-grow: 1; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    text-align: left;
}

/* ê¸°ì¡´íŒŒì¼ ì‚­ì œë²„íŠ¼ */
.file-delete-btn {
	width: 20px;
    height: 20px;
    padding: 0;
    border: 1px solid #e0baba;
    border-radius: 50%;
    background: #ffebeb;
    color: #cc4c4c;
    font-size: 12px;
    line-height: 18px;
    text-align: center;
    cursor: pointer;
    flex-shrink: 0;
}

.file-delete-btn:hover {
	background: #ffdede; /* ë°°ê²½ìƒ‰ ì‚´ì§ ì–´ë‘¡ê²Œ */
    color: #a03c3c;         /* ì•„ì´ì½˜ ìƒ‰ìƒ ì§„í•˜ê²Œ */
    border-color: #cc4c4c;
}
</style>
</head>
<body>
<%
String idx = request.getParameter("idx");

Connection conn=null;
Statement st = null;
ResultSet rs = null;
String sql = null;

try{
    conn = DB.getConnection();
    
   sql = " SELECT b.idx, b.title, b.content, b.ip, b.uid, b.boardtype, g.* FROM board b LEFT JOIN board_gallery g ON b.idx = g.bidx where b.idx = '"+idx+"' ";

   st = conn.createStatement();
   rs = st.executeQuery(sql);

  }catch(Exception e){ 
    e.printStackTrace();
    out.println(sql);
 }
String uid = "";
String title = "";
String content = "";
String ip = "";
String originalfile[] = new String[10];
String boardtype = "";
int i=0;
while (rs.next()) {
	
	title = rs.getString("title");
	content = rs.getString("content");
	ip = rs.getString("ip");
	uid = rs.getString("uid");
	originalfile[i] = rs.getString("originalfile");
	boardtype = rs.getString("boardtype");
	i++;
}
%>

<%@ include file="op_top.jsp" %>
<%@ include file="../include/side_nav.jsp" %>

<%

if (login_rank == 9) {
	
}else if (0 < login_rank && login_rank < 9) {
	if(login_id == null || !login_id.equals(uid)) {
		if (boardtype.equals("1") || boardtype.equals("0")) {
			%>
			<script>
			alert("ê¶Œí•œ ì—†ìŒ");
			location.replace("view.jsp?idx=<%= idx %>");
			</script>
			<%
			return;
		}
	}
}else {
	if (boardtype.equals("1") || boardtype.equals("0")) {
		%>
		<script>
		alert("ê¶Œí•œ ì—†ìŒ");
		location.replace("view.jsp?idx=<%= idx %>");
		</script>
		<%
		return;
	}
}

%>

<h1>ê°¤ëŸ¬ë¦¬ ìˆ˜ì •</h1><br>
<form name="modify_form" action="modify_proc.jsp" method="post" enctype="multipart/form-data" class="write-form">
	<input type="hidden" name="idx" value="<%= idx %>">
	<input type="hidden" name="ip" value="<%= ip %>">
	<table>

		<tr>
			<td>ì œëª©</td>
			<td><input type="text" name="writetitle" value="<%= title %>"></td>
		</tr>
		
		<tr>
			<td>ë‚´ìš©</td>
			<td>
				<textarea class="text" name="writetext"><%= content %></textarea>
			</td>
		</tr>
		
		<tr>
			<td>íŒŒì¼</td>
			<td>

				

			<div id="keep_file">
			<%
				for (int j=0; j<i; j++) {
			%>
					<div class="file-item">
						<button type="button" class="file-delete-btn">X</button>
						<span class="file-name-display">ê¸°ì¡´ íŒŒì¼ : <%= originalfile[j] %></span>
						<input type="hidden" name="keep_file_<%= j %>" value="file_<%= j %>">
					</div>
			<%
				}
			%>
			</div>
			
			<div id="del_file">
			
			</div>
			
			<div id="file_container_0" class="file-container">
			    	<input type="file" name="upfile_0" id="upfile_0" accept=".gif, .jpg, .png"><br>
			</div>
			
			</td>
		</tr>
		
		<tr>
			<td colspan="2">
				<input type="button" class="modify_sub" value="ìˆ˜ì •" onclick="gallery_modify_submit()">
				<a href="view.jsp?idx=<%= idx %>"><button type="button" class="btn-cancel">ì·¨ì†Œ</button></a>
			</td>
		</tr>
		
	</table>
</form>

<script>
// ==========================================================
// ì „ì—­ ë³€ìˆ˜: í˜„ì¬ ë‚¨ì•„ìˆëŠ” ê¸°ì¡´ íŒŒì¼ì˜ ê°œìˆ˜
let keepfile_length; 
const file_total = 10; // íŒŒì¼ ì—…ë¡œë“œ ì œí•œ ìˆ˜ (ìµœëŒ€ 10ê°œ)
// ==========================================================
	
// Xë²„íŠ¼ ëˆ„ë¥´ë©´ ê¸°ì¡´ íŒŒì¼ ì‚­ì œí•˜ëŠ” ê¸°ë¯¹
document.addEventListener('DOMContentLoaded', function() {
    const deleteButtons = document.querySelectorAll('#keep_file .file-delete-btn');
    const deletedFilesContainer = document.getElementById('del_file');

    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const isConfirmed = confirm("ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");

            if (isConfirmed) {
                const fileItem = this.closest('.file-item');
                
                // ğŸ’¡ ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ì‹œ, ì „ì—­ ë³€ìˆ˜ keepfile_length ê°ì†Œ
                keepfile_length--;
                
                if (fileItem) {
                    const hiddenInput = fileItem.querySelector('input[type="hidden"]');
                    
                    if (hiddenInput) {
                        hiddenInput.name = 'deleted_files'; 
                        deletedFilesContainer.appendChild(hiddenInput);
                    }

                    fileItem.remove();
                    
                    console.log(`íŒŒì¼ ì‚­ì œ ì™„ë£Œ. ë‚¨ì€ ê¸°ì¡´ íŒŒì¼ ìˆ˜: ${keepfile_length}`);
                }
            } else {
                console.log('íŒŒì¼ ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        });
    });
});

// ìˆ˜ì •ë²„íŠ¼ submit
function gallery_modify_submit() {
    const form = document.forms['modify_form'];
    
    const keptFiles = document.querySelectorAll('#keep_file .file-item');
    const hasKeptFiles = keptFiles.length > 0;
    
    let hasNewFiles = false;
    const newFileInputs = form.querySelectorAll('input[type="file"]');

    newFileInputs.forEach(input => {
        if (input.value) { 
            hasNewFiles = true;
        }
    });

    if (hasKeptFiles || hasNewFiles) {
        console.log("í¼ ì œì¶œì„ ì§„í–‰í•©ë‹ˆë‹¤.");
        form.submit();
    } else {
        alert("í•˜ë‚˜ ì´ìƒì˜ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ê¸°ì¡´ íŒŒì¼ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.");
    }
}

/*íŒŒì¼ ì„ íƒì°½ ì¶”ê°€ ê¸°ë¯¹*/
document.addEventListener('DOMContentLoaded', () => {
    const fileArea = document.querySelector('.write-form tbody tr:nth-child(3) td:nth-child(2)');
    let fileIndex = 0;
    const keepfiles = document.querySelectorAll('#keep_file .file-item');
    
    // ğŸ’¡ ì „ì—­ ë³€ìˆ˜ keepfile_length ì´ˆê¸°í™”
    keepfile_length = keepfiles.length;
    
    addEventListenersToFileInput(document.getElementById('upfile_0'));

    function addEventListenersToFileInput(inputElement) {
        inputElement.addEventListener('change', handleFileChange);
    }

    // íŒŒì¼ ë³€ê²½ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    function handleFileChange(event) {
        const currentInput = event.target;
        const container = currentInput.closest('.file-container');
        const allInputs = fileArea.querySelectorAll('input[type="file"]');
        
        if (!container) return;
        
        if (currentInput.files.length > 0) {
            
            // 1. í˜„ì¬ íŒŒì¼ ì…ë ¥ í•„ë“œ ì¤‘ ê°’ì´ ìˆëŠ”(ì„ íƒëœ) ê°œìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
            let selectedNewFilesCount = 0;
            allInputs.forEach(input => {
                // í˜„ì¬ inputì„ í¬í•¨í•˜ì—¬ ê°’ì´ ìˆëŠ” input ê°œìˆ˜
                if (input.value) {
                    selectedNewFilesCount++;
                }
            });
            
            // 2. ì´ íŒŒì¼ ê°œìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. (ê¸°ì¡´ íŒŒì¼ ìˆ˜ + ìƒˆë¡œ ì„ íƒëœ íŒŒì¼ ìˆ˜)
            const totalFiles = keepfile_length + selectedNewFilesCount;
            
            // ğŸš¨ [ìˆ˜ì •] ì´ íŒŒì¼ ê°œìˆ˜ê°€ file_total (10)ì„ ì´ˆê³¼í•˜ë©´ ê²½ê³ ë¥¼ ë„ì›ë‹ˆë‹¤. 
            // ì¦‰, 11ë²ˆì§¸ íŒŒì¼ì„ ì„ íƒí•  ë•Œ ê²½ê³ ê°€ ëœ¹ë‹ˆë‹¤.
            if (totalFiles > file_total) {
                alert('ë” ì´ìƒ íŒŒì¼ì„ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ìµœëŒ€ ' + file_total + 'ê°œ)');
                currentInput.value = '';
                return; 
            }
        }
        
        const existingCancelButton = container.querySelector('.cancel-button');
        if (existingCancelButton) {
            existingCancelButton.remove();
        }

        if (currentInput.files.length > 0) {
            addCancelButton(container);

            const isLastInput = currentInput === allInputs[allInputs.length - 1];

            if (isLastInput) {
                addNewFileInput();
            }
        }
    }

    // ì·¨ì†Œ ë²„íŠ¼ì„ ìƒì„±í•˜ê³  ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    function addCancelButton(container) {
        const newCancelButton = document.createElement('button');
        newCancelButton.type = 'button';
        newCancelButton.className = 'cancel-button';
        newCancelButton.textContent = 'ì·¨ì†Œ';

        newCancelButton.addEventListener('click', () => {
            container.remove();

            if (!fileArea.querySelector('.file-container')) {
                fileIndex = 0;
                addNewFileInput(true);
            }
        });

        container.appendChild(newCancelButton);
    }

    // ìƒˆë¡œìš´ íŒŒì¼ ì…ë ¥ í•„ë“œë¥¼ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    function addNewFileInput(isInitial = false) {
        const allInputs = fileArea.querySelectorAll('input[type="file"]');
        
        // 1. í˜„ì¬ ì¡´ì¬í•˜ëŠ” íŒŒì¼ì˜ ì´ ê°œìˆ˜ (ê¸°ì¡´ íŒŒì¼ + í˜„ì¬ ì…ë ¥ í•„ë“œ ê°œìˆ˜)
        const currentTotalInputs = keepfile_length + allInputs.length;
        
        // ğŸš¨ [ìˆ˜ì •] íŒŒì¼ ì…ë ¥ í•„ë“œê°€ ì´ë¯¸ file_totalê³¼ ê°™ê±°ë‚˜ ë§ìœ¼ë©´ ì¶”ê°€ë¥¼ ë§‰ìŠµë‹ˆë‹¤.
        // í˜„ì¬ 10ê°œì˜ íŒŒì¼ì´ ìˆë‹¤ë©´, ì…ë ¥ í•„ë“œëŠ” 0ê°œê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. 
        // 9ê°œì˜ íŒŒì¼ì´ ìˆë‹¤ë©´, ì…ë ¥ í•„ë“œëŠ” 1ê°œê°€ ë‚¨ì•„ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        if (currentTotalInputs >= file_total) {
             if (!isInitial) {
                 alert(`ë” ì´ìƒ íŒŒì¼ ì…ë ¥ í•„ë“œë¥¼ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì´ ${file_total}ê°œê¹Œì§€ ê°€ëŠ¥)`);
             }
            return; 
        }

        if (!isInitial) {
            fileIndex++;
        }

        const newContainer = document.createElement('div');
        newContainer.id = `file_container_${fileIndex}`;
        newContainer.className = 'file-container';

        const newInput = document.createElement('input');
        newInput.type = 'file';
        newInput.name = `upfile_${fileIndex}`;
        newInput.id = `upfile_${fileIndex}`;
        newInput.accept = '.gif, .jpg, .png';

        newContainer.appendChild(newInput);
        fileArea.appendChild(newContainer);

        addEventListenersToFileInput(newInput);
    }
});
</script>

</body>
</html>