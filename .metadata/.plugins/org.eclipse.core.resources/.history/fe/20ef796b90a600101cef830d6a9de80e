//======================== ì „ì—­ ìƒíƒœ ê´€ë¦¬ ===============================
const MAX_FILES = 10;
let filesToUpload = []; // ìƒˆë¡œ ì—…ë¡œë“œí•  íŒŒì¼ ê°ì²´ë“¤ì„ ì €ì¥í•  ë°°ì—´
let fileIndexCounter = 0; // ìƒˆë¡œ ì¶”ê°€ë˜ëŠ” íŒŒì¼ì— ê³ ìœ  IDë¥¼ ë¶€ì—¬í•˜ê¸° ìœ„í•œ ì¹´ìš´í„°

// ì´ˆê¸° ê¸°ì¡´ íŒŒì¼ ê°œìˆ˜ ì„¤ì • (JSPì˜ total_file_count hidden inputì—ì„œ ê°€ì ¸ì˜´)
let initialFileCount = parseInt(document.getElementById('total-file-count').value); 

//===================================================================

document.addEventListener('DOMContentLoaded', function() {
    const fileList = document.getElementById('file-list');
    const actualInput = document.getElementById('file-input-actual');
    const selectButton = document.getElementById('select-file-button');

    // 1. 'íŒŒì¼ ì¶”ê°€' ë²„íŠ¼ í´ë¦­ -> ìˆ¨ê²¨ì§„ Input ì‹¤í–‰
    selectButton.addEventListener('click', () => {
        // â­ íŒŒì¼ ì œí•œ ì´ˆê³¼ ì‹œ ì„ íƒ ë°©ì§€
        if (getOverallFileCount() >= MAX_FILES) {
            alert(`ë” ì´ìƒ íŒŒì¼ì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ìµœëŒ€ ${MAX_FILES}ê°œ)`);
            return;
        }
        actualInput.click();
    });

    // 2. ì‹¤ì œ Inputì— íŒŒì¼ì´ ì„ íƒë˜ì—ˆì„ ë•Œ
    actualInput.addEventListener('change', (e) => {
        const selectedFiles = Array.from(e.target.files);
        
        // ğŸš¨ Input valueë¥¼ ë¹„ì›Œì•¼ ë‹¤ìŒì— ê°™ì€ íŒŒì¼ì„ ì„ íƒí•´ë„ change ì´ë²¤íŠ¸ê°€ ë°œìƒí•¨
        actualInput.value = ''; 

        selectedFiles.forEach(file => {
            if (getOverallFileCount() < MAX_FILES) {
                // ìƒˆë¡œìš´ íŒŒì¼ ê°ì²´ë¥¼ ë°°ì—´ì— ì¶”ê°€í•˜ê³  ê³ ìœ  ID ë¶€ì—¬
                const fileId = 'new_' + fileIndexCounter++;
                filesToUpload.push({ id: fileId, file: file });
                
                // UIì— ëª©ë¡ ì¶”ê°€
                renderNewFileItem(file.name, fileId);
                
            } else {
                alert(`"${file.name}" íŒŒì¼ì„ ì œì™¸í•˜ê³  ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. (ìµœëŒ€ ${MAX_FILES}ê°œ)`);
            }
        });
        
        updateFileCountDisplay();
    });

    // 3. íŒŒì¼ ëª©ë¡ ì „ì²´ì— ëŒ€í•œ ì‚­ì œ ì´ë²¤íŠ¸ ìœ„ì„
    fileList.addEventListener('click', (e) => {
        if (!e.target.classList.contains('delete-btn')) return;

        const button = e.target;
        const type = button.dataset.type;
        const fileId = button.dataset.fileId;
        const fileItem = button.closest('.file-item');

        if (!confirm("ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        if (type === 'existing') {
            // A. ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ì²˜ë¦¬
            const deletedInput = document.getElementById('deleted-file-ids-input');
            deletedInput.value += (deletedInput.value ? ',' : '') + fileId;
            
            // â­ keep_file hidden input ì œê±° (ì„œë²„ì—ì„œ ìœ ì§€í•  íŒŒì¼ ëª©ë¡ì—ì„œ ì œì™¸)
            fileItem.querySelector(`input[name="keep_file_${fileId}"]`).remove();
            
        } else if (type === 'new') {
            // B. ìƒˆë¡œ ì„ íƒí•œ ì„ì‹œ íŒŒì¼ ì‚­ì œ ì²˜ë¦¬
            filesToUpload = filesToUpload.filter(item => item.id !== fileId);
        }

        // UIì—ì„œ ì œê±°
        fileItem.remove();
        updateFileCountDisplay();
    });
    
    // 4. Submit ì‹œ íŒŒì¼ ê°ì²´ë¥¼ ìµœì¢… Inputì— ë‹´ëŠ” ì²˜ë¦¬ (ë§¤ìš° ì¤‘ìš”)
    document.forms['modify_form'].addEventListener('submit', (e) => {
        // filesToUpload ë°°ì—´ì— ìˆëŠ” íŒŒì¼ ê°ì²´ë“¤ì„ ì‹¤ì œ input[type=file]ì— í• ë‹¹
        const dataTransfer = new DataTransfer();
        filesToUpload.forEach(item => {
            dataTransfer.items.add(item.file);
        });
        actualInput.files = dataTransfer.files;

        if (getOverallFileCount() === 0) {
             alert("í•˜ë‚˜ ì´ìƒì˜ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ê¸°ì¡´ íŒŒì¼ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.");
             e.preventDefault(); // íŒŒì¼ì´ ì—†ìœ¼ë©´ ì „ì†¡ ë°©ì§€
        }
    });

    // ì´ˆê¸° íŒŒì¼ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    updateFileCountDisplay();
});

//======================== í—¬í¼ í•¨ìˆ˜ ===============================

// í˜„ì¬ ì´ íŒŒì¼ ê°œìˆ˜ ê³„ì‚° í•¨ìˆ˜ (ê¸°ì¡´ íŒŒì¼ + ì„ì‹œ íŒŒì¼)
function getOverallFileCount() {
    // #file-listì˜ ëª¨ë“  .file-item ê°œìˆ˜ë¥¼ ì„¸ëŠ” ê²ƒì´ ê°€ì¥ ì •í™•í•¨
    return document.querySelectorAll('#file-list .file-item').length;
}

// UIì— ìƒˆë¡œìš´ íŒŒì¼ í•­ëª©ì„ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
function renderNewFileItem(fileName, fileId) {
    const li = document.createElement('li');
    li.className = 'file-item new';
    li.dataset.fileId = fileId;
    li.innerHTML = `
        <span class="file-name-display">ìƒˆ íŒŒì¼ : ${fileName}</span>
        <button type="button" class="delete-btn" data-type="new" data-file-id="${fileId}">âŒ</button>
    `;
    document.getElementById('file-list').appendChild(li);
}

// íŒŒì¼ ê°œìˆ˜ í‘œì‹œë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
function updateFileCountDisplay() {
    const count = getOverallFileCount();
    document.getElementById('current-file-count').textContent = count;
    
    const selectButton = document.getElementById('select-file-button');
    if (count >= MAX_FILES) {
        selectButton.disabled = true;
        selectButton.textContent = 'íŒŒì¼ ì¶”ê°€ (ìµœëŒ€ ê°œìˆ˜ ë„ë‹¬)';
    } else {
        selectButton.disabled = false;
        selectButton.textContent = 'íŒŒì¼ ì¶”ê°€';
    }
}


function gallery_modify_submit() {
    const form = document.forms['modify_form'];

    if (form) {
        form.submit();
    }
}