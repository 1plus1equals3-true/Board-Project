//======================== ì „ì—­ ìƒíƒœ ê´€ë¦¬ ===============================
const MAX_FILES = 10;
let fileIndexCounter = 0;

// â­â­ ì „ì—­ì—ì„œ ì„ ì–¸ë§Œ í•˜ê³ , ê°’ í• ë‹¹ì€ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. â­â­
let initialFileCount = 0; 
//===================================================================

document.addEventListener('DOMContentLoaded', function() {
    
    // â­â­ ì•ˆì „í•˜ê²Œ DOM ìš”ì†Œ ë¡œë“œ í›„ ê°’ í• ë‹¹ ë° ì´ˆê¸° íŒŒì¼ ê°œìˆ˜ ì„¤ì • â­â­
    const totalCountInput = document.getElementById('total-file-count');
    
    // null ì²´í¬ë¥¼ í•˜ì—¬ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê³ , ì°¾ì§€ ëª»í•˜ë©´ 0ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    if (totalCountInput) {
        initialFileCount = parseInt(totalCountInput.value);
    } else {
        console.error("ì˜¤ë¥˜: ID 'total-file-count' ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. HTMLì— IDê°€ ë§ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
        initialFileCount = 0;
    }
    
    const fileList = document.getElementById('file-list');
    const tempInput = document.getElementById('file-input-temp');
    const dynamicContainer = document.getElementById('dynamic-file-inputs-container');
    const selectButton = document.getElementById('select-file-button');

    // 1. 'íŒŒì¼ ì¶”ê°€' ë²„íŠ¼ í´ë¦­ -> ìˆ¨ê²¨ì§„ Input ì‹¤í–‰
    selectButton.addEventListener('click', () => {
        // â­ íŒŒì¼ ì œí•œ ì´ˆê³¼ ì‹œ ì„ íƒ ë°©ì§€
        if (getOverallFileCount() >= MAX_FILES) {
            alert(`ë” ì´ìƒ íŒŒì¼ì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ìµœëŒ€ ${MAX_FILES}ê°œ)`);
            return;
        }
        // â­ tempInputì„ í´ë¦­í•˜ë„ë¡ ë³€ê²½
        tempInput.click();
    });

    // 2. ì‹¤ì œ Input(tempInput)ì— íŒŒì¼ì´ ì„ íƒë˜ì—ˆì„ ë•Œ
    // â­ ë¦¬ìŠ¤ë„ˆë¥¼ tempInputì— ì—°ê²°í•©ë‹ˆë‹¤. (multipleì´ ì—†ìœ¼ë¯€ë¡œ files[0]ë§Œ ì²˜ë¦¬)
    tempInput.addEventListener('change', (e) => {
        // tempInputì€ multipleì´ ì—†ìœ¼ë¯€ë¡œ ì„ íƒëœ íŒŒì¼ì€ e.target.files[0] í•˜ë‚˜ì…ë‹ˆë‹¤.
        const selectedFile = e.target.files[0];
        
        // ğŸš¨ Input valueë¥¼ ë¹„ì›Œì•¼ ë‹¤ìŒì— ê°™ì€ íŒŒì¼ì„ ì„ íƒí•´ë„ change ì´ë²¤íŠ¸ê°€ ë°œìƒí•¨
        tempInput.value = ''; 

        if (selectedFile) {
            // íŒŒì¼ ê°œìˆ˜ ì œí•œ ì²´í¬
            if (getOverallFileCount() < MAX_FILES) {
                
                // â­ í•µì‹¬ ë¡œì§: íŒŒì¼ ê°ì²´ë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±ëœ Inputì— í• ë‹¹
                const fileId = 'new_' + fileIndexCounter++;
                
                // 1. ì„œë²„ ì „ì†¡ìš© <input type="file"> ìš”ì†Œ ìƒì„±
                const permanentInput = createPermanentFileInput(fileId, selectedFile);

                // 2. í¼ì— ì¶”ê°€
                dynamicContainer.appendChild(permanentInput);
                
                // 3. UIì— ëª©ë¡ ì¶”ê°€
                renderNewFileItem(selectedFile.name, fileId);
                
            } else {
                alert(`"${selectedFile.name}" íŒŒì¼ì„ ì œì™¸í•˜ê³  ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. (ìµœëŒ€ ${MAX_FILES}ê°œ)`);
            }
        }
        
        updateFileCountDisplay();
    });

    // 3. íŒŒì¼ ëª©ë¡ ì „ì²´ì— ëŒ€í•œ ì‚­ì œ ì´ë²¤íŠ¸ ìœ„ì„ (B. ìƒˆë¡œ ì„ íƒí•œ ì„ì‹œ íŒŒì¼ ì‚­ì œ ì²˜ë¦¬ ìˆ˜ì •)
    fileList.addEventListener('click', (e) => {
        if (!e.target.classList.contains('delete-btn')) return;

        const button = e.target;
        const type = button.dataset.type;
        const fileId = button.dataset.fileId;
        const fileItem = button.closest('.file-item');

        if (!confirm("ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        if (type === 'existing') {
            // A. ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ì²˜ë¦¬ (ë¡œì§ ìœ ì§€)
            const deletedInput = document.getElementById('deleted-file-ids-input');
            deletedInput.value += (deletedInput.value ? ',' : '') + fileId;
            
            // keep_file hidden input ì œê±° (ì„œë²„ì—ì„œ ìœ ì§€í•  íŒŒì¼ ëª©ë¡ì—ì„œ ì œì™¸)
            fileItem.querySelector(`input[name="keep_file_${fileId}"]`).remove();
            
        } else if (type === 'new') {
            // â­ B. ìƒˆë¡œ ì„ íƒí•œ íŒŒì¼ ì‚­ì œ ì²˜ë¦¬ (JS ë°°ì—´ ëŒ€ì‹  ë™ì  Input ì œê±°)
            
            // í¼ì—ì„œ í•´ë‹¹ <input name="upfile_N"> ìš”ì†Œë¥¼ ì œê±°
            const inputName = 'upfile_' + fileId.replace('new_', '');
            const permanentInput = dynamicContainer.querySelector(`input[name="${inputName}"]`);
            if (permanentInput) {
                permanentInput.remove();
            }
            
            // ê¸°ì¡´ filesToUpload ë°°ì—´ ê´€ë ¨ ì½”ë“œëŠ” ì œê±°í•©ë‹ˆë‹¤.
        }

        // UIì—ì„œ ì œê±°
        fileItem.remove();
        updateFileCountDisplay();
    });
    
    // 4. Submit ì‹œ íŒŒì¼ ê°ì²´ë¥¼ ìµœì¢… Inputì— ë‹´ëŠ” ì²˜ë¦¬ (âŒ ì´ ë¡œì§ ì „ì²´ ì œê±°)
    document.forms['modify_form'].addEventListener('submit', (e) => {
        // âŒ DataTransferë¥¼ í†µí•œ files ì†ì„± ì¡°ì‘ ë¡œì§ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤!
        // íŒŒì¼ë“¤ì€ ì´ë¯¸ ë™ì ìœ¼ë¡œ ìƒì„±ëœ Input ìš”ì†Œì— ë‹´ê²¨ í¼ì— ì¶”ê°€ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
        
        if (getOverallFileCount() === 0) {
             alert("í•˜ë‚˜ ì´ìƒì˜ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ê¸°ì¡´ íŒŒì¼ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.");
             e.preventDefault(); // íŒŒì¼ì´ ì—†ìœ¼ë©´ ì „ì†¡ ë°©ì§€
        }
    });

    // ì´ˆê¸° íŒŒì¼ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    updateFileCountDisplay();
});

//======================== í—¬í¼ í•¨ìˆ˜ ===============================
// â­ ìƒˆë¡œ ì¶”ê°€ëœ í•¨ìˆ˜: íŒŒì¼ ê°ì²´ë¥¼ ë‹´ì€ ìˆ¨ê²¨ì§„ Inputì„ ìƒì„±í•©ë‹ˆë‹¤.
function createPermanentFileInput(fileId, fileObject) {
    const inputName = 'upfile_' + fileId.replace('new_', '');

    const permanentInput = document.createElement('input');
    permanentInput.type = 'file';
    permanentInput.name = inputName; 
    permanentInput.style.display = 'none';
    
    // DataTransfer ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ê°ì²´ë¥¼ Inputì— í• ë‹¹ (í•µì‹¬)
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(fileObject);
    permanentInput.files = dataTransfer.files;

    return permanentInput;
}


// í˜„ì¬ ì´ íŒŒì¼ ê°œìˆ˜ ê³„ì‚° í•¨ìˆ˜ (ê¸°ì¡´ íŒŒì¼ + ì„ì‹œ íŒŒì¼)
function getOverallFileCount() {
    // #file-listì˜ ëª¨ë“  .file-item ê°œìˆ˜ë¥¼ ì„¸ëŠ” ê²ƒì´ ê°€ì¥ ì •í™•í•¨
    return document.querySelectorAll('#file-list .file-item').length;
}

// UIì— ìƒˆë¡œìš´ íŒŒì¼ í•­ëª©ì„ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
function renderNewFileItem(fileName, fileId) {
    const li = document.createElement('li');
    li.className = 'file-item new';
    li.dataset.fileId = fileId;
    li.innerHTML = `
        <span class="file-name-display">ìƒˆ íŒŒì¼ : ${fileName}</span>
        <button type="button" class="delete-btn" data-type="new" data-file-id="${fileId}">âŒ</button>
    `;
    document.getElementById('file-list').appendChild(li);
}

// íŒŒì¼ ê°œìˆ˜ í‘œì‹œë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
function updateFileCountDisplay() {
    const count = getOverallFileCount();
    document.getElementById('current-file-count').textContent = count;
    
    const selectButton = document.getElementById('select-file-button');
    if (count >= MAX_FILES) {
        selectButton.disabled = true;
        selectButton.textContent = 'íŒŒì¼ ì¶”ê°€ (ìµœëŒ€ ê°œìˆ˜ ë„ë‹¬)';
    } else {
        selectButton.disabled = false;
        selectButton.textContent = 'íŒŒì¼ ì¶”ê°€';
    }
}


function gallery_modify_submit() {
    const form = document.forms['modify_form'];

    if (form) {
        form.submit();
    }
}