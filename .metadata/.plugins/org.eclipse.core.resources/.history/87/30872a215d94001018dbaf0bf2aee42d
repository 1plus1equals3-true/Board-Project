<%@page import="java.awt.PageAttributes.OrientationRequestedType"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ page import="java.sql.*"%>        
<%@ page import="lib.DB" %>
<%@ page trimDirectiveWhitespaces="true" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ê¸€ë³´ê¸°</title>
<style>
*{
	margin: 0 auto;
	padding: 0;
	text-align: center;
	box-sizing: border-box;
}
.view-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin: 20px auto;
    max-width: 800px;
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.view-table tr:first-child td {
    background-color: #f8f9fa;
    font-size: 1.2em;
    font-weight: bold;
    padding: 15px;
    text-align: left;
    border-bottom: 2px solid #ced4da;
}

.view-table tr:nth-child(2) td {
    padding: 10px 15px;
    color: #6c757d;
    border-bottom: 1px solid #e9ecef;
}

.view-table tr:nth-child(n) td {
    padding: 10px 15px;
    border-bottom: 1px solid #e9ecef;
}

.view-table tr:nth-child(2) td:not(:last-child) {
    /*border-right: 1px solid #e9ecef;*/
}

.view-table tr:last-child td {
    padding: 20px 15px;
    line-height: 1.6;
    word-break: break-all;
    min-height: 200px;
}

.view-table .text {
    white-space: pre-wrap;
}

.button-group {
    text-align: center;
    margin-top: 20px;
}

.button-group button {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin: 0 4px;
}

.button-group .btn-modify {
    background-color: #ffc107;
    color: #343a40;
}

.button-group .btn-modify:hover {
    background-color: #e0a800;
}

.button-group .btn-delete {
    background-color: #dc3545;
    color: white;
}

.button-group .btn-delete:hover {
    background-color: #c82333;
}

.button-group .btn-list {
    background-color: #007bff;
    color: white;
}

.button-group .btn-list:hover {
    background-color: #0056b3;
}

.comment-form {
    display: flex; /* Use flexbox to align items horizontally */
    align-items: center; /* Vertically center the input and button */
    padding: 10px 15px; /* Add some padding, similar to the table cells */
}

.comment-form textarea {
    flex-grow: 1; /* Make the textarea take up the available space */
    margin-right: 10px; /* Add some space between the textarea and the button */
    padding: 8px; /* Padding inside the textarea */
    border: 1px solid #ced4da; /* A subtle border */
    border-radius: 4px; /* Slightly rounded corners */
    font-size: 14px; /* Match the font size of the table */
    resize: vertical; /* Allow vertical resizing, but not horizontal */
    min-height: 50px; /* Give it a minimum height */
    text-align: left;
}

.comment-form button {
    padding: 8px 16px; /* Padding for the button */
    background-color: #007bff; /* Use a primary color, similar to your list button */
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.comment-form button:hover {
    background-color: #0056b3;
}

.delete-button {
    display: inline-block; /* <a> íƒœê·¸ê°€ íŒ¨ë”©ê³¼ ë§ˆì§„ì„ ê°€ì§ˆ ìˆ˜ ìˆë„ë¡ ë¸”ë¡ ìš”ì†Œì²˜ëŸ¼ ë™ì‘í•˜ê²Œ í•¨ */
    padding: 8px 16px; /* í¼ ë²„íŠ¼ê³¼ ë™ì¼í•œ íŒ¨ë”© */
    background-color: #dc3545; /* ì‚­ì œë¥¼ ì˜ë¯¸í•˜ëŠ” ë¹¨ê°„ìƒ‰ */
    color: white; /* í°ìƒ‰ ê¸€ì */
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    text-decoration: none; /* ê¸°ë³¸ ë°‘ì¤„ ì œê±° */
}

.delete-button:hover {
    background-color: #c82333; /* ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ ë” ì–´ë‘ìš´ ë¹¨ê°„ìƒ‰ */
}

.modify-button {
    display: inline-block; /* <a> íƒœê·¸ê°€ íŒ¨ë”©ê³¼ ë§ˆì§„ì„ ê°€ì§ˆ ìˆ˜ ìˆë„ë¡ ë¸”ë¡ ìš”ì†Œì²˜ëŸ¼ ë™ì‘í•˜ê²Œ í•¨ */
    padding: 8px 16px; /* í¼ ë²„íŠ¼ê³¼ ë™ì¼í•œ íŒ¨ë”© */
    background-color: #ffc107; /* ì£¼í™©ìƒ‰ */
    color: black; /*  ê¸€ì */
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    text-decoration: none; /* ê¸°ë³¸ ë°‘ì¤„ ì œê±° */
}

.modify-button:hover {
    background-color: #e0a800; /* ë” ì§„í•œ ì£¼í™©ìƒ‰ í˜¸ë²„ */
}

.edit-form {
    display: flex;
    align-items: center;
    gap: 10px; /* ìš”ì†Œë“¤ ì‚¬ì´ì— ê°„ê²©ì„ ì¤ë‹ˆë‹¤ */
}

.edit-form textarea {
    flex-grow: 1;
    padding: 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    resize: vertical;
    min-height: 50px;
    text-align: left;
}

.edit-form .btn-submit { /* ìˆ˜ì • ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    padding: 8px 16px;
    background-color: #ffc107; /* modify-button ìƒ‰ìƒê³¼ ë§ì¶¤ */
    color: black;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.edit-form .btn-cancel { /* ì·¨ì†Œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    padding: 8px 16px;
    background-color: #dc3545; /* delete-button ìƒ‰ìƒê³¼ ë§ì¶¤ */
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

section img {
width: 200px;
object-fit: contain;
}

.td40 {
	width: 40%;
}

.td20 {
	width: 20%;
}

</style>
</head>
<body>

<%
String idx = request.getParameter("idx");

Connection conn=null;
Statement st = null;
PreparedStatement ps = null;
ResultSet rs = null;
 
String sql = null;

String cidx = "";
String comname = "";
String ment = "";
String comdate = "";
String cuid = "";
String boardtype = "";
int temp_rank = -1;

try{
    
   conn = DB.getConnection();

   sql = "SELECT b.* FROM board b where b.idx='"+idx+"'";
   st = conn.createStatement();
   rs = st.executeQuery(sql);
    
  }catch(Exception e){ 
    e.printStackTrace();
    out.println(sql);
}

//--------

if(rs != null){
	rs.next();
	String name = rs.getString("name");
	String title = rs.getString("title");
	String content = rs.getString("content");
	String hit = rs.getString("hit");
	String regdate = rs.getString("regdate");
	String ip = rs.getString("ip");
	String uid = rs.getString("uid");
	String upfile = rs.getString("upfile");
	String originalfile = rs.getString("originalfile");
	boardtype = rs.getString("boardtype");
	
	int ihit = Integer.parseInt(hit);
	ihit+=1;
	hit = Integer.toString(ihit);
	
try {
	
	conn = DB.getConnection();
	sql = "update board set hit=? where idx=?";
	ps = conn.prepareStatement(sql);
	ps.setString(1, hit);
	ps.setString(2, idx);
	ps.executeUpdate();
	
}catch(Exception e){ 
	  out.println(e.toString());
	  out.println(sql);
}

	
	

%>
<%@ include file="op_top.jsp" %>
<% temp_rank = login_rank; %>
<section class="min-height">
<h1>ì‘ì„± ê¸€</h1><br>

<table class="view-table">

	<tr>
		<td colspan="4"><%= title %></td>
	</tr>
	
	<tr>
		<td>ì‘ì„±ì : <%= name %></td>
		<td>ì‘ì„±ì¼ì : <%= regdate %></td>
		<td>ì¡°íšŒìˆ˜ : <%= hit %></td>
		<td>ì•„ì´í”¼ : <%= ip %></td>
	</tr>
	
	<tr>
		<td colspan="4"><div style="min-height: 200px;"><%= content.replace("\r\n","<br>") %></div></td>
	</tr>
	
	<tr>
		<% if (upfile != null) { %>
			<td>íŒŒì¼</td>
			<td colspan="3">
				<img alt="<%= originalfile %>" src="download.jsp?idx=<%= idx %>"><br>
				<a href="download.jsp?idx=<%= idx %>" target="_blank">ë‹¤ìš´ë¡œë“œ</a>
		<% } %>
			</td>
	</tr>
	
</table>

<%
try {
	conn = DB.getConnection();
	sql = " SELECT c.*, m.name as comname from comment c LEFT JOIN member m ON c.uid = m.uid where bidx="+ idx;
	st = conn.createStatement();
	rs = st.executeQuery(sql);
	
}catch(Exception e){ 
    e.printStackTrace();
    out.println(sql);
}
%>

<table class="view-table">

<tr>
	<td colspan="4">ëŒ“ê¸€</td>
</tr>

<tr>
	<td class="td20">ì‘ì„±ì</td>
	<td class="td40">ë‚´ìš©</td>
	<td class="td20">ì‘ì„±ì¼ì</td>
	<td class="td20"></td>
</tr>

<%
   while (rs.next()) {
      cidx = rs.getString("idx");
      comname = rs.getString("comname");
      ment = rs.getString("ment");
      comdate = rs.getString("regdate");
      cuid = rs.getString("uid");
   
%>
		
	<tr id="row-<%= cidx %>">
	    <td><%= comname %></td>
	    <td id="ment-<%= cidx %>" style="text-align: left;"><%= ment.replace("\r\n","<br>") %></td>
	    <td><%= comdate %></td>
	<% if (cuid != null && cuid.equals(login_id)) { %>
	    <td>
	        <button class="modify-button" onclick="toggleEditRow('<%= cidx %>')">ìˆ˜ì •</button>
	        <a href="deletecheck_com.jsp?idx=<%= cidx %>" class="delete-button">ì‚­ì œ</a>
	    </td>
    <% }else { %>
    	<td></td>
    <% } %>
	</tr>

	<tr id="edit-row-<%= cidx %>" style="display:none;">
	    <td><%= comname %></td>
	    <td colspan="3">
	    	<form id="editForm-<%= cidx %>" action="comment_modify.jsp" method="post" class="edit-form">
	    		<input type="hidden" name="idx" value="<%= idx %>">
	    		<input type="hidden" name="cidx" value="<%= cidx %>">
		        <textarea name="commentmodify"><%= ment %></textarea>
		        <button type="submit" class="btn-submit">ìˆ˜ì •</button>
		        <button type="button" class="btn-cancel" onclick="cancelEdit('<%= cidx %>')">ì·¨ì†Œ</button>
	        </form>
	        
	    </td>
	</tr>

<% } %>

<% if(login_id != null) { %>
<tr>
	<td></td>
	<td colspan="3">
		<form action="comment_proc.jsp" method="post" class="comment-form">
			<input type="hidden" name="bidx" value="<%= idx %>">
			<textarea name="commenttext"></textarea>
			<button type="submit">ë“±ë¡</button>
		</form>
	</td>
</tr>
<% }else{ %>
<tr>
	<td></td>
	<td colspan="3">
		ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.
	</td>
</tr>
<% } %>
</table>

<br>
<div class="button-group">
<button type="button" class="btn-modify" onclick="modify()">ìˆ˜ì •</button>
<button type="button" class="btn-delete" onclick="wdelete()">ì‚­ì œ</button>
<button type="button" onclick="list_back()" class="btn-list">ëª©ë¡</button>
</div>
</section>
<%@ include file="op_bot.jsp" %>
<%
}

if (rs != null){
   rs.close();
}

if (ps != null){
	   ps.close();
}

if (st != null){
   st.close();
}

if (conn != null){
   conn.close();
}
%>

<script>

//í¼ ì œì¶œ ì´ë²¤íŠ¸ë¥¼ ê°€ë¡œì±„ Ajax ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
document.querySelectorAll('.edit-form').forEach(form => {
    form.addEventListener('submit', function(event) {
        // 1. í¼ì˜ ê¸°ë³¸ ì œì¶œ ë™ì‘(í˜ì´ì§€ ë¦¬í”„ë ˆì‹œ) ë°©ì§€
        event.preventDefault();

        const formElement = event.target;
        
        // í¼ ë°ì´í„°ë¥¼ ì„œë²„ì— ì „ì†¡í•  í˜•íƒœë¡œ ì¤€ë¹„
        const formData = new FormData(formElement);

        // ğŸ¯ ìˆ˜ì •: FormDataì—ì„œ cidxì™€ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œ
        const cidx = formData.get('cidx');
        const newCommentText = formData.get('commentmodify'); 
        
     // 1ë‹¨ê³„ ë””ë²„ê¹…: cidx ê°’ì´ ì •í™•í•œì§€ í™•ì¸
        console.log('--- cidx ê°’ ë””ë²„ê¹… ---');
        console.log('ì¶”ì¶œëœ cidx ê°’:', cidx);
        console.log('DOMì—ì„œ ì°¾ì„ ID:', `ment-${cidx}`);
        
        // ... (Fetch í†µì‹  ì½”ë“œ ìƒëµ)
        fetch(formElement.action, {
            method: 'POST', 
            // FormDataë¥¼ URLSearchParamsë¡œ ë³€í™˜í•˜ì—¬ Content-Type ì„¤ì •
            body: new URLSearchParams(formData), 
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜');
            }
            return response.json(); 
        })
        .then(data => {
            // 3. ì„œë²„ ì‘ë‹µ ì²˜ë¦¬
            if (data.success) { 
                
                // 4. í™”ë©´ ì—…ë°ì´íŠ¸ (DOM ì¡°ì‘)
                const commentDisplayArea = document.getElementById(`ment-${cidx}`);

                // 2ë‹¨ê³„ ë””ë²„ê¹…: ê°±ì‹  ëŒ€ìƒ ìš”ì†Œ í™•ì¸
                console.log('ê°±ì‹  ëŒ€ìƒ ìš”ì†Œ:', commentDisplayArea); // nullì´ë©´ ID ì˜¤ë¥˜

                if (commentDisplayArea) {
                    // ëŒ“ê¸€ ë‚´ìš©ì„ ìƒˆ í…ìŠ¤íŠ¸ë¡œ êµì²´
                    // HTMLì— <br> íƒœê·¸ë¡œ ì¤„ë°”ê¿ˆì„ ì ìš©í•˜ê¸° ìœ„í•´ innerHTML ì‚¬ìš©
                    // newCommentTextëŠ” <textarea>ì˜ ê°’ì´ë©°, \r\n ë˜ëŠ” \nì„ ê°€ì§.
                    const formattedText = newCommentText.replace(/\r?\n/g, '<br>');
                    
                    // 3ë‹¨ê³„ ë””ë²„ê¹…: ìµœì¢… ì‚½ì…ë  HTML í™•ì¸
                    console.log('ìµœì¢… ì‚½ì… HTML:', formattedText);

                    commentDisplayArea.innerHTML = formattedText;
                }
                
                // 5. ìˆ˜ì • í¼ ìˆ¨ê¸°ê¸° ë° ì›ë˜ ëŒ“ê¸€ í–‰ ë‹¤ì‹œ í‘œì‹œ
                cancelEdit(cidx); 
                
                alert('ëŒ“ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
            } else {
                alert('ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        })
        .catch(error => {
            console.error('Fetch ì—ëŸ¬:', error);
            alert('ëŒ“ê¸€ ìˆ˜ì • ì¤‘ í†µì‹  ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    });
});


//ëŒ“ê¸€ í† ê¸€
function toggleEditRow(cidx) {
    var originalRow = document.getElementById("row-" + cidx);
    var editRow = document.getElementById("edit-row-" + cidx);

    if (originalRow.style.display !== 'none') {
        originalRow.style.display = 'none';
        editRow.style.display = 'table-row'; //
    } else {
        originalRow.style.display = 'table-row';
        editRow.style.display = 'none';
    }
}

//ëŒ“ê¸€ ì·¨ì†Œ ë²„íŠ¼
function cancelEdit(cidx) {
    var originalRow = document.getElementById("row-" + cidx);
    var editRow = document.getElementById("edit-row-" + cidx);

    originalRow.style.display = 'table-row';
    editRow.style.display = 'none';
}
//ê¸€ ëª©ë¡ ë²„íŠ¼
function list_back() {
	var boardtype = "<%= boardtype %>";
	
	if (boardtype == "0") {
		window.location.href = 'list_notice.jsp';
	}else if (boardtype == "1") {
		window.location.href = 'list_member.jsp';
	}else {
		window.location.href = 'list_anonymity.jsp';
	}
}
//ê¸€ ìˆ˜ì • ë²„íŠ¼
function modify() {
	var idx = "<%= idx %>";
	var boardtype = "<%= boardtype %>";
	var login_rank = "<%= temp_rank %>";
	
	if (boardtype == "0") {
		if (login_rank == 9) {
			window.location.href = 'modify.jsp?idx=' + idx;
		}else {
			alert("ê¶Œí•œ ì—†ìŒ")
			return;
		}
		
	}else if (boardtype == "1") {
		if (login_rank == 9) {
			window.location.href = 'modify.jsp?idx=' + idx;
		}else if (0 <= login_rank && login_rank < 9) {
			let passinput = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
					if (passinput === null) {
						return;
					} else if (passinput === "") {
						alert("ì•„ë¬´ê²ƒë„ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
						return;
					} else {
						window.location.href = 'modify_check.jsp?idx=' + idx + "&passinput=" + passinput;
						return;
					}

		}else {
			alert("ê¶Œí•œ ì—†ìŒ")
			return;
		}
		
	}else {
		if (login_rank == 9) {
			window.location.href = 'modify.jsp?idx=' + idx;
		}else {
			let passinput = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
			if (passinput === null) {
				return;
			} else if (passinput === "") {
				alert("ì•„ë¬´ê²ƒë„ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
				return;
			} else {
				window.location.href = 'modify_check.jsp?idx=' + idx + "&passinput=" + passinput + "&type=anony";
				return;
			}
		}
	}
}
//ê¸€ ì‚­ì œ ë²„íŠ¼
function wdelete() {
	var idx = "<%= idx %>";
	var boardtype = "<%= boardtype %>";
	var login_rank = "<%= temp_rank %>";
	
	if (boardtype == "0") {
		if (login_rank == 9) {
			var con_del_check = confirm("ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
			if (con_del_check) {
				location.replace("../board_proc/delete_proc.jsp?idx=<%= idx %>");
			}
			
		}else {
			alert("ê¶Œí•œ ì—†ìŒ")
			return;
		}
		
	}else if (boardtype == "1") {
		if (login_rank == 9) {
			var con_del_check = confirm("ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
			if (con_del_check) {
				location.replace("../board_proc/delete_proc.jsp?idx=<%= idx %>");
			}
			
		}else if (0 <= login_rank && login_rank < 9) {
			let passinput = prompt('ì‚­ì œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
					if (passinput === null) {
						return;
					} else if (passinput === "") {
						alert("ì•„ë¬´ê²ƒë„ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
						return;
					} else {
						location.replace("../board_proc/delete_check.jsp?idx=<%= idx %>&passinput="+passinput);
						return;
					}

		}else {
			alert("ê¶Œí•œ ì—†ìŒ")
			return;
		}
		
	}else {
		if (login_rank == 9) {
			var con_del_check = confirm("ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
			if (con_del_check) {
				location.replace("../board_proc/delete_proc.jsp?idx=<%= idx %>");
			}
			
		}else {
			let passinput = prompt('ì‚­ì œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
			if (passinput === null) {
				return;
			} else if (passinput === "") {
				alert("ì•„ë¬´ê²ƒë„ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
				return;
			} else {
				location.replace("../board_proc/delete_check.jsp?idx=<%= idx %>&passinput="+passinput+"&type=anony");
				return;
			}
		}
	}
}
</script>

</body>
</html>