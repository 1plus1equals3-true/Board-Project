//======================== 전역 상태 관리 ===============================
const MAX_FILES = 10;
let fileIndexCounter = 0;

// 전역에서 선언만 하고, DOMContentLoaded에서 기존 파일 개수로 초기화됩니다.
let initialFileCount = 0; 
//===================================================================

document.addEventListener('DOMContentLoaded', function() {
    
    // ⭐ 1. 초기 파일 개수 안정적으로 초기화 (DOM에 있는 기존 파일 아이템 개수를 셈)
    const existingFiles = document.querySelectorAll('#file-list .file-item.existing');
    initialFileCount = existingFiles.length; 
    
    // 2. DOM 요소 변수 할당
    const fileList = document.getElementById('file-list');
    const tempInput = document.getElementById('file-input-temp'); // 임시 Input
    const dynamicContainer = document.getElementById('dynamic-file-inputs-container'); // 동적 Input 컨테이너
    const selectButton = document.getElementById('select-file-button');
    
    // 3. '파일 추가' 버튼 클릭 -> 숨겨진 Input 실행
    selectButton.addEventListener('click', () => {
        // 파일 제한 초과 시 선택 방지
        if (getOverallFileCount() >= MAX_FILES) {
            alert(`더 이상 파일을 추가할 수 없습니다. (최대 ${MAX_FILES}개)`);
            return;
        }
        // tempInput.click()이 버튼 클릭을 대신합니다.
        tempInput.click();
    });

    // 4. 임시 Input(tempInput)에 파일이 선택되었을 때 (핵심: 동적 Input 생성)
    tempInput.addEventListener('change', (e) => {
        // tempInput은 multiple이 없으므로 선택된 파일은 e.target.files[0] 하나입니다.
        const selectedFile = e.target.files[0];
        
        // Input value를 비워야 다음에 같은 파일을 선택해도 change 이벤트가 발생합니다.
        tempInput.value = ''; 

        if (selectedFile) {
            if (getOverallFileCount() < MAX_FILES) {
                
                // A. 파일 객체를 동적으로 생성된 Input에 할당
                const fileId = 'new_' + fileIndexCounter++;
                const permanentInput = createPermanentFileInput(fileId, selectedFile);

                // B. 폼에 Input 추가 (서버 전송 대상이 됨)
                dynamicContainer.appendChild(permanentInput);
                
                // C. UI에 목록 추가
                renderNewFileItem(selectedFile.name, fileId);
                
            } else {
                alert(`"${selectedFile.name}" 파일을 제외하고 처리되었습니다. (최대 ${MAX_FILES}개)`);
            }
        }
        
        updateFileCountDisplay();
    });

    // 5. 파일 목록 전체에 대한 삭제 이벤트 위임
    fileList.addEventListener('click', (e) => {
        if (!e.target.classList.contains('delete-btn')) return;

        const button = e.target;
        const type = button.dataset.type;
        const fileId = button.dataset.fileId;
        const fileItem = button.closest('.file-item');

        if (!confirm("이 파일을 삭제하시겠습니까?")) return;

        if (type === 'existing') {
            // A. 기존 파일 삭제 처리 (서버로 삭제할 파일 PK 전송)
            const deletedInput = document.getElementById('deleted-file-ids-input');
            if (deletedInput) { 
                deletedInput.value += (deletedInput.value ? ',' : '') + fileId;
            }
            
            // keep_file hidden input 제거 (서버가 이 파일을 유지하지 않도록 함)
            const keepFileInput = fileItem.querySelector(`input[name="keep_file_${fileId}"]`);
            if(keepFileInput) {
                keepFileInput.remove();
            }
            
        } else if (type === 'new') {
            // B. 새로 선택한 파일 삭제 처리 (동적 Input 제거)
            
            // 폼에서 해당 <input name="upfile_N"> 요소를 제거
            const inputIndex = fileId.replace('new_', '');
            const inputName = 'upfile_' + inputIndex;
            const permanentInput = dynamicContainer.querySelector(`input[name="${inputName}"]`);
            if (permanentInput) {
                permanentInput.remove();
            }
        }

        // UI에서 제거
        fileItem.remove();
        updateFileCountDisplay();
    });
    
    // 6. Submit 시 최종 파일 개수만 확인 (동적 Input이 알아서 전송되므로 DataTransfer 불필요)
    document.forms['modify_form'].addEventListener('submit', (e) => {
		if (getOverallFileCount() === 0) {
		             alert("수정하려면 최소 하나의 파일은 유지하거나 업로드해야 합니다.");
		             e.preventDefault(); // 폼 제출을 막습니다.
		             return; // 함수 종료
		        }
    });

    // 초기 파일 카운트 업데이트
    updateFileCountDisplay();
});

//======================== 헬퍼 함수 ===============================

// 파일 객체를 담은 숨겨진 Input을 생성하고 파일을 할당합니다.
function createPermanentFileInput(fileId, fileObject) {
    const inputName = 'upfile_' + fileId.replace('new_', '');

    const permanentInput = document.createElement('input');
    permanentInput.type = 'file';
    permanentInput.name = inputName; 
    permanentInput.style.display = 'none';
    
    // DataTransfer 객체를 사용하여 파일 객체를 Input에 할당 (핵심)
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(fileObject);
    permanentInput.files = dataTransfer.files;

    return permanentInput;
}


// 현재 총 파일 개수 계산 함수 (가장 정확한 방법: DOM에서 <li> 개수를 셈)
function getOverallFileCount() {
    return document.querySelectorAll('#file-list .file-item').length;
}

// UI에 새로운 파일 항목을 추가하는 함수
function renderNewFileItem(fileName, fileId) {
    const li = document.createElement('li');
    li.className = 'file-item new';
    li.dataset.fileId = fileId;
    li.innerHTML = `
        <span class="file-name-display">새 파일 : ${fileName}</span>
        <button type="button" class="delete-btn" data-type="new" data-file-id="${fileId}">❌</button>
    `;
    document.getElementById('file-list').appendChild(li);
}

// 파일 개수 표시를 업데이트하는 함수
function updateFileCountDisplay() {
    const count = getOverallFileCount();
    document.getElementById('current-file-count').textContent = count;
    
    const selectButton = document.getElementById('select-file-button');
    if (count >= MAX_FILES) {
        selectButton.disabled = true;
        selectButton.textContent = '파일 추가 (최대 개수 도달)';
    } else {
        selectButton.disabled = false;
        selectButton.textContent = '파일 추가';
    }
}


function gallery_modify_submit() {
    const form = document.forms['modify_form'];

    if (form) {
        form.submit();
    }
}